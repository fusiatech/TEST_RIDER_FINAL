name: Azure Web App Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: swarm-ui
  AZURE_WEBAPP_PACKAGE_PATH: '.'
  NODE_VERSION: '20.x'

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run typecheck

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload artifact for deployment
        uses: actions/upload-artifact@v7
        with:
          name: node-app
          path: |
            .next
            public
            package.json
            package-lock.json
            server.ts
            server
            lib
            tsconfig.json
          retention-days: 1

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    permissions:
      contents: none

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app

      - name: Setup Node.js for deployment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install production dependencies
        run: npm ci --omit=dev

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: Health check
        id: health-check
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          
          HEALTH_URL="${{ steps.deploy-to-webapp.outputs.webapp-url }}/api/health"
          echo "Checking health at: $HEALTH_URL"
          
          for i in {1..5}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i: Got HTTP $RESPONSE, retrying in 10s..."
            sleep 10
          done
          
          echo "Health check failed after 5 attempts"
          exit 1

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    environment:
      name: production
    permissions:
      contents: read

    steps:
      - name: Notify rollback
        run: |
          echo "::warning::Deployment failed! Manual rollback may be required."
          echo "Please check Azure Portal for previous deployment slots."

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Swap to previous slot
        if: success()
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az webapp deployment slot swap \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --slot staging \
              --target-slot production || echo "Slot swap failed or not configured"
        continue-on-error: true
