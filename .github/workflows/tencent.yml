name: Tencent Kubernetes Engine

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  TKE_IMAGE_URL: ccr.ccs.tencentyun.com/swarm-ui/app
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-swarm-ui
  DEPLOYMENT_NAME: swarm-ui
  NAMESPACE: default

permissions:
  contents: read

jobs:
  build-and-deploy:
    name: Build and Deploy to TKE
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run typecheck

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build \
            --tag ${{ env.TKE_IMAGE_URL }}:${{ github.sha }} \
            --tag ${{ env.TKE_IMAGE_URL }}:latest \
            --build-arg NODE_ENV=production \
            .

      - name: Login to TKE Registry
        run: |
          docker login \
            -u ${{ secrets.TENCENT_CLOUD_ACCOUNT_ID }} \
            -p '${{ secrets.TKE_REGISTRY_PASSWORD }}' \
            ccr.ccs.tencentyun.com

      - name: Push Docker image
        run: |
          docker push ${{ env.TKE_IMAGE_URL }}:${{ github.sha }}
          docker push ${{ env.TKE_IMAGE_URL }}:latest

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Set up Kustomize
        run: |
          curl -sLo kustomize.tar.gz https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.3.0/kustomize_v5.3.0_linux_amd64.tar.gz
          tar xzf kustomize.tar.gz
          chmod +x kustomize
          sudo mv kustomize /usr/local/bin/

      - name: Configure TKE cluster credentials
        uses: TencentCloud/tke-cluster-credential-action@v1
        with:
          secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
          secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
          tke_region: ${{ env.TKE_REGION }}
          cluster_id: ${{ env.TKE_CLUSTER_ID }}

      - name: Switch to TKE context
        run: |
          kubectl config use-context ${{ env.TKE_CLUSTER_ID }}-context-default

      - name: Deploy to TKE
        run: |
          # Update image in kustomization if it exists
          if [ -f kustomization.yaml ]; then
            kustomize edit set image ${{ env.TKE_IMAGE_URL }}:${{ github.sha }}
            kustomize build . | kubectl apply -f -
          else
            # Direct deployment update
            kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
              ${{ env.DEPLOYMENT_NAME }}=${{ env.TKE_IMAGE_URL }}:${{ github.sha }} \
              -n ${{ env.NAMESPACE }} || \
            kubectl create deployment ${{ env.DEPLOYMENT_NAME }} \
              --image=${{ env.TKE_IMAGE_URL }}:${{ github.sha }} \
              -n ${{ env.NAMESPACE }}
          fi

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} \
            -n ${{ env.NAMESPACE }} \
            --timeout=300s

      - name: Verify deployment
        run: |
          kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }}
          kubectl get pods -l app=${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }}
          kubectl get services -n ${{ env.NAMESPACE }}

      - name: Health check
        run: |
          # Get service endpoint
          SERVICE_IP=$(kubectl get svc ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          
          if [ -n "$SERVICE_IP" ]; then
            echo "Checking health at http://$SERVICE_IP:3000/api/health"
            for i in {1..5}; do
              RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://$SERVICE_IP:3000/api/health" || echo "000")
              if [ "$RESPONSE" = "200" ]; then
                echo "Health check passed!"
                exit 0
              fi
              echo "Attempt $i: Got HTTP $RESPONSE, retrying in 10s..."
              sleep 10
            done
            echo "::warning::Health check did not pass, but deployment completed"
          else
            echo "::notice::No LoadBalancer IP available yet, skipping health check"
          fi
